# Спецификация: Правила грамматики для format_map

## Why

Система карточек использует format_map для механической трансформации слов по правилам грамматики. Необходимо определить, какие правила из rules.md подходят под эту механику (с format_map), а какие нужно добавить как справочные (format_map: null).

## What Changes

- Добавить все правила грамматики в `grammar.json`
- Поддерживающие format_map - с трансформациями
- Неподдерживающие - с format_map: null (для чтения)
- Добавить новые функции трансформации в `forms_verb.rs`
- Добавить новые функции трансформации в `forms_adjective.rs`

## Impact

- Affected code: `origa/src/domain/grammar/grammar.json`, `forms_verb.rs`, `forms_adjective.rs`

---

## ADDED Requirements

### Requirement: Подходящие правила N5 (с format_map)

| Урок | Правило             | Часть речи  | Трансформация                  | Приоритет |
| ---- | ------------------- | ----------- | ------------------------------ | --------- |
| 4    | 〜ます              | Verb        | to_masu_form                   | HIGH      |
| 4    | 〜ません            | Verb        | to_masen_form                  | HIGH      |
| 4    | 〜ました            | Verb        | to_mashita_form                | HIGH      |
| 4    | 〜ませんでした      | Verb        | to_masen_deshita_form          | HIGH      |
| 6    | 〜ませんか          | Verb        | to_masen_form + か             | MEDIUM    |
| 6    | 〜ましょう          | Verb        | to_main_view + ましょう        | HIGH      |
| 8    | い形です            | IAdjective  | no change + です               | HIGH      |
| 8    | い形ないです        | IAdjective  | to_kunai_form + です           | HIGH      |
| 8    | な形じゃありません  | NaAdjective | no change + じゃありません     | HIGH      |
| 12   | い形かったです      | IAdjective  | to_katta_form + です           | HIGH      |
| 12   | な形でした          | NaAdjective | no change + でした             | HIGH      |
| 13   | Vたいです           | Verb        | to_main_view + たいです        | MEDIUM    |
| 14   | Vてください         | Verb        | to_te_form + ください          | HIGH      |
| 14   | Vています           | Verb        | to_te_form + います            | HIGH      |
| 14   | Vましょうか         | Verb        | to_main_view + ましょうか      | MEDIUM    |
| 15   | Vている             | Verb        | to_te_form + いる              | HIGH      |
| 16   | い形くて            | IAdjective  | to_kute_form                   | MEDIUM    |
| 16   | な形で              | NaAdjective | no change + で                 | MEDIUM    |
| 17   | Vないでください     | Verb        | to_nai_form + でください       | MEDIUM    |
| 17   | Vなければなりません | Verb        | to_nai_form + ければなりません | MEDIUM    |
| 17   | Vなくてもいいです   | Verb        | to_nai_form + くてもいいです   | MEDIUM    |
| 19   | Vたことがあります   | Verb        | to_ta_form + ことがあります    | LOW       |
| 19   | い形くなります      | IAdjective  | to_ku_form + なります          | MEDIUM    |
| 19   | な形になります      | NaAdjective | no change + になります         | MEDIUM    |
| 20   | 普通体動詞          | Verb        | to_dictionary_form             | HIGH      |
| 20   | 普通体い形容詞      | IAdjective  | remove です                    | HIGH      |
| 20   | 普通体な形容詞      | NaAdjective | to_na_form + だ                | HIGH      |
| 21   | 〜でしょう          | Verb/Adj    | no change + でしょう           | LOW       |
| 23   | い形容詞とき        | IAdjective  | to_ku_form + とき              | LOW       |
| 23   | な形容詞なとき      | NaAdjective | to_na_form + とき              | LOW       |
| 25   | 〜たら              | Verb        | to_tara_form                   | MEDIUM    |
| 25   | 〜ても              | Verb        | to_te_form + も                | MEDIUM    |

### Requirement: Подходящие правила N4 (с format_map)

| Урок | Правило                 | Часть речи      | Трансформация                   | Приоритет |
| ---- | ----------------------- | --------------- | ------------------------------- | --------- |
| 27   | 可能形                  | Verb            | to_potential_form               | MEDIUM    |
| 27   | 〜しか〜ません          | Verb            | to_masen_form (с частицей しか) | LOW       |
| 29   | Vてしまいます           | Verb            | to_te_form + しまいます         | MEDIUM    |
| 29   | Vてしまいました         | Verb            | to_te_form + しまいました       | MEDIUM    |
| 30   | Vておきます             | Verb            | to_te_form + おきます           | MEDIUM    |
| 31   | 意向形                  | Verb            | to_volitional_form              | MEDIUM    |
| 31   | まだ〜ていません        | Verb            | to_te_form + いません           | LOW       |
| 33   | 命令形                  | Verb            | to_imperative_form              | LOW       |
| 33   | 禁止形                  | Verb            | to_te_form + はいけません       | LOW       |
| 34   | 〜て / 〜ないで         | Verb            | to_te_form / to_nai_form + で   | MEDIUM    |
| 35   | Vば                     | Verb            | to_ba_form                      | MEDIUM    |
| 35   | い形ければ              | IAdjective      | to_kereba_form                  | MEDIUM    |
| 35   | な形なら                | NaAdjective     | to_nara_form                    | MEDIUM    |
| 37   | 受身                    | Verb            | to_passive_form                 | MEDIUM    |
| 40   | Vてみます               | Verb            | to_te_form + みます             | LOW       |
| 43   | 〜そうです (Hearsay)    | Verb/Adj        | to_dictionary_form + そうです   | LOW       |
| 43   | Vて来ます               | Verb            | to_te_form + 来ます             | LOW       |
| 44   | 〜すぎます              | Verb/IAdjective | to_stem_form + すぎます         | MEDIUM    |
| 44   | 〜やすい                | Verb            | to_stem_form + やすい           | LOW       |
| 44   | 〜にくい                | Verb            | to_stem_form + にくい           | LOW       |
| 44   | 〜くします (i-adj)      | IAdjective      | to_ku_form + します             | MEDIUM    |
| 44   | 〜にします (na-adj)     | NaAdjective     | no change + にします            | MEDIUM    |
| 46   | 〜たばかりです          | Verb            | to_ta_form + ばかりです         | LOW       |
| 47   | 〜そうです (Appearance) | Verb/Adj        | to_sou_form                     | LOW       |
| 47   | 〜ようです              | Verb/Adj        | to_dictionary_form + ようです   | LOW       |
| 48   | 使役                    | Verb            | to_causative_form               | LOW       |
| 49   | お〜になります          | Verb            | to_o_ni_narimasu_form           | LOW       |
| 49   | お/ご〜ください         | Verb            | to_o_kudasai_form               | LOW       |
| 50   | お/ご〜します           | Verb            | to_o_shimasu_form               | LOW       |

### Requirement: Подходящие правила N3 (с format_map)

| Урок | Правило            | Часть речи | Трансформация                 | Приоритет |
| ---- | ------------------ | ---------- | ----------------------------- | --------- |
| 2    | 〜たら、〜た       | Verb       | to_tara_form                  | MEDIUM    |
| 2    | 〜みたいだ         | Verb/Adj   | to_dictionary_form + みたいだ | LOW       |
| 3    | 〜そうな〜         | Verb/Adj   | to_sou_form + な              | LOW       |
| 3    | 〜なさそう         | Adj        | to_nasasou_form               | LOW       |
| 3    | 〜そうもない       | Verb       | to_sou_form + もない          | LOW       |
| 3    | 〜ないでほしい     | Verb       | to_nai_form + でほしい        | LOW       |
| 4    | 〜ちゃう           | Verb       | to_te_form → ちゃう           | LOW       |
| 4    | 〜とく             | Verb       | to_te_form → とく             | LOW       |
| 4    | 〜てる             | Verb       | to_te_form → てる             | LOW       |
| 4    | 〜（さ）せられる   | Verb       | to_causative_passive_form     | LOW       |
| 4    | 〜がる             | Adj        | to_garu_form                  | LOW       |
| 5    | 〜（よ）うとする   | Verb       | to_volitional_form + とする   | LOW       |
| 5    | 〜たところに       | Verb       | to_ta_form + ところに         | LOW       |
| 6    | 〜てばかりいる     | Verb       | to_te_form + ばかりいる       | LOW       |
| 6    | 〜てくる           | Verb       | to_te_form + くる             | LOW       |
| 6    | 〜ていく           | Verb       | to_te_form + いく             | LOW       |
| 8    | 〜たまま           | Verb       | to_ta_form + まま             | LOW       |
| 9    | お〜ますです       | Verb       | to_o_masu_form                | LOW       |
| 10   | 複合動詞: 〜出す   | Verb       | to_stem_form + だす           | LOW       |
| 10   | 複合動詞: 〜始める | Verb       | to_stem_form + はじめる       | LOW       |
| 10   | 複合動詞: 〜終わる | Verb       | to_stem_form + おわる         | LOW       |
| 10   | 複合動詞: 〜続ける | Verb       | to_stem_form + つづける       | LOW       |
| 10   | 複合動詞: 〜忘れる | Verb       | to_stem_form + わすれる       | LOW       |
| 10   | 複合動詞: 〜合う   | Verb       | to_stem_form + あう           | LOW       |
| 10   | 複合動詞: 〜換える | Verb       | to_stem_form + かえる         | LOW       |
| 11   | 〜らしい           | Verb/Adj   | to_dictionary_form + らしい   | LOW       |
| 11   | 〜ず               | Verb       | to_zu_form                    | LOW       |
| 12   | 〜たり             | Verb       | to_ta_form + り               | LOW       |
| 12   | 〜っぱなし         | Verb       | to_te_form + っぱなし         | LOW       |
| 13   | 〜たて             | Verb       | to_ta_form + て               | LOW       |
| 13   | たとえ〜ても       | Verb       | to_te_form + も               | LOW       |

---

### Requirement: Неподходящие правила N5 (format_map: null)

Эти правила требуют контекста или дополнительных слов, но должны быть в grammar.json для чтения:

| Урок | Правило                              | Причина                          |
| ---- | ------------------------------------ | -------------------------------- |
| 1    | 名詞文：〜は〜です                   | Требует двух существительных     |
| 1    | 〜は〜じゃありません                 | Требует двух существительных     |
| 1    | 〜は〜ですか                         | Требует двух существительных     |
| 1    | 〜の〜（所属）                       | Требует двух существительных     |
| 1    | 〜も〜です                           | Требует двух существительных     |
| 4    | 〜時〜分です                         | Требует чисел                    |
| 4    | 〜は〜曜日です                       | Требует существительных          |
| 4    | 〜から〜まで                         | Частицы                          |
| 8    | い形＋名詞です                       | Прилагательное + существительное |
| 8    | な形な＋名詞です                     | Прилагательное + существительное |
| 12   | 名詞文過去                           | Существительные в прошедшем      |
| 2    | これ/それ/あれは＜物＞です           | Указательные местоимения         |
| 2    | これ/それ/あれは〜ですか、〜ですか   | Указательные местоимения         |
| 2    | この/その/あの＜物＞は＜人＞のです   | Указательные местоимения         |
| 3    | ここは＜場所＞です                   | Требует существительного         |
| 3    | ＜物・人＞は＜場所＞です             | Требует существительных          |
| 5    | ＜場所＞へ行きます                   | Требует частиц                   |
| 5    | ＜乗り物＞で行きます                 | Требует частиц                   |
| 5    | ＜人＞と行きます                     | Требует частиц                   |
| 7    | ＜道具・手段＞で〜ます               | Требует контекста                |
| 7    | わたしは＜人＞に＜物＞を〜ます       | Требует контекста                |
| 7    | もう〜ました                         | Наречие                          |
| 9    | 好き/嫌い/上手/下手                  | Конкретные прилагательные        |
| 9    | わかります/あります                  | Конкретные глаголы               |
| 9    | から（理由）                         | Частица                          |
| 10   | あります/います（存在文）            | Конкретные глаголы               |
| 11   | 助数詞                               | Счётные слова                    |
| 11   | ＜１週間に○回＞                      | Требует чисел                    |
| 11   | 〜から〜まで＜時間・期間＞かかります | Требует контекста                |
| 12   | 〜は〜より（形容詞）です             | Сравнение                        |
| 12   | 〜のほうが（形容詞）です             | Сравнение                        |
| 12   | 〜で〜がいちばん（形容詞）です       | Сравнение                        |
| 13   | ほしいです                           | Конкретное слово                 |
| 13   | PlaceへV/Nに行きます                 | Требует контекста                |
| 15   | Vてもいいですか                      | Требует контекста                |
| 15   | Vてはいけません                      | Требует контекста                |
| 16   | V1て、V2〜                           | Два глагола                      |
| 16   | Vてから、〜                          | Требует контекста                |
| 16   | 〜は〜が〜                           | Требует существительных          |
| 18   | 辞書形：ことができます               | Требует контекста                |
| 18   | （趣味）は〜ことです                 | Требует контекста                |
| 18   | V/Nのまえに                          | Требует контекста                |
| 19   | Vたり、Vたりします                   | Два глагола                      |
| 21   | 〜と思います（推量・意見）           | Требует контекста                |
| 21   | 〜と言いました                       | Требует контекста                |
| 22   | 〜は 文+N です                       | Существительные                  |
| 22   | 文+N は〜です                        | Существительные                  |
| 22   | 文+N を〜 / 文+N が〜                | Существительные                  |
| 24   | くれる                               | Конкретный глагол                |
| 24   | 〜てあげる                           | Требует направления              |
| 24   | 〜てもらう                           | Требует направления              |
| 24   | 〜てくれる                           | Требует направления              |

### Requirement: Неподходящие правила N4 (format_map: null)

| Урок | Правило                                        | Причина                              |
| ---- | ---------------------------------------------- | ------------------------------------ |
| 26   | 〜んですか                                     | Требует контекста                    |
| 26   | どうして〜んですか                             | Требует контекста                    |
| 26   | 〜んですが、〜ていただけませんか               | Требует контекста                    |
| 26   | 疑問詞〜たらいいですか                         | Требует контекста                    |
| 27   | 〜が見えます / 聞こえます                      | Конкретные глаголы                   |
| 27   | 〜ができます                                   | Конкретный глагол                    |
| 27   | 〜は〜、〜は〜（対比）                         | Требует контекста                    |
| 28   | 〜ながら                                       | Два действия                         |
| 28   | 〜ています（習慣）                             | Требует контекста                    |
| 28   | 〜し、〜し、〜                                 | Два действия                         |
| 29   | 自動詞・他動詞                                 | Классификация                        |
| 30   | 〜が〜てあります / 〜は〜てあります            | Требует контекста                    |
| 31   | ＜意向形＞と思っています                       | Требует контекста                    |
| 31   | 〜つもりです / 〜予定です                      | Требует контекста                    |
| 32   | 〜ほうがいいです                               | Требует контекста                    |
| 32   | 〜かもしれません                               | Требует контекста                    |
| 33   | 「〜」と書いてあります/読みます                | Требует контекста                    |
| 33   | 〜は〜という意味です                           | Требует контекста                    |
| 33   | 〜と言っていました                             | Требует контекста                    |
| 33   | 〜と伝えていただけませんか                     | Требует контекста                    |
| 34   | 〜とおりに、〜                                 | Требует контекста                    |
| 34   | 〜あとで                                       | Требует контекста                    |
| 35   | 疑問詞〜ばいいですか                           | Требует контекста                    |
| 35   | Nなら、〜                                      | Существительное                      |
| 36   | 〜ように、〜（目標）                           | Требует контекста                    |
| 36   | 〜ようになります（変化）                       | Требует контекста                    |
| 36   | 〜ようにしています（習慣）                     | Требует контекста                    |
| 36   | 〜ようにしてください                           | Требует контекста                    |
| 38   | 〜のは＜形容詞＞です                           | Требует контекста                    |
| 38   | 〜のが＜形容詞＞です                           | Требует контекста                    |
| 38   | 〜のを忘れました                               | Требует контекста                    |
| 38   | 〜のを知っています                             | Требует контекста                    |
| 38   | 〜のは＜名詞＞です                             | Требует контекста                    |
| 39   | （名詞）で                                     | Соединительная форма существительных |
| 39   | 〜ので、〜                                     | Требует контекста                    |
| 40   | 疑問詞〜か                                     | Требует контекста                    |
| 40   | 〜かどうか、〜                                 | Требует контекста                    |
| 41   | 〜をいただきます/〜をくださいます/〜をやります | Требует контекста                    |
| 41   | 〜ていただきます/〜てくださいます/〜てやります | Требует направления                  |
| 41   | 〜てくださいませんか                           | Требует контекста                    |
| 42   | 〜ために、〜                                   | Требует контекста                    |
| 42   | 〜は〜のに、〜                                 | Требует контекста                    |
| 42   | 〜のに〜かかります                             | Требует контекста                    |
| 45   | 〜場合は、〜                                   | Требует контекста                    |
| 45   | 〜のに、〜                                     | Требует контекста                    |
| 46   | 〜ところです                                   | Требует контекста                    |
| 46   | 〜はずです                                     | Требует контекста                    |
| 48   | 〜させていただけませんか                       | Требует контекста                    |
| 49   | 〜られます                                     | Требует контекста                    |
| 49   | 特別な尊敬語                                   | Классификация                        |

### Requirement: Неподходящие правила N3 (format_map: null)

Большинство правил N3 - составные конструкции, неподходящие для format_map:

| Урок | Примеры правил                                                                                                                               |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| 1    | 〜てもらえませんか, 〜のようだ, 〜ことを, 〜を〜と言う, どんなに〜ても                                                                       |
| 3    | 〜（さ）せてもらえませんか, …ことにする, …ことになる, 〜てほしい                                                                             |
| 4    | …ということだ, …の・…の？, 〜である, …こと・…ということ                                                                                      |
| 5    | あ〜・そ〜, …んじゃない？, …のだろうか, …だろう                                                                                              |
| 6    | …て… / …って…（цитата）, 〜つもりはない, …とか…                                                                                              |
| 7    | 〜なくてはならない, …だけだ, …かな, 〜なんか…                                                                                                |
| 8    | 〜あいだ, 〜まで, 〜によって, …からだ                                                                                                        |
| 9    | 〜てもかまわない, …ほど〜ない, …ため［に］                                                                                                   |
| 10   | …はずだ, …ことが／もある, 〜た結果                                                                                                           |
| 11   | 〜てくる・〜ていく（изменение）, 〜たら［どう］？, …より…ほうが…, 〜として, 〜ている（опыт）                                                 |
| 13   | 〜たりしない, 〜ほど, …んだって？, 〜ながら, 〜よね                                                                                          |
| 14   | 〜際, 〜といった, 〜に（も）わたって, 〜うちに, 〜にとって, 〜とは, 〜において, …わけだ                                                      |
| 15   | …という, 〜たびに, 〜に関する, …わけではない, …ではないか, …のだ                                                                             |
| 16   | 〜に応じる・〜に応じて, 〜によって, 〜とみられる, …としている, 〜にもかかわらず, …とともに, 〜たところ                                       |
| 17   | 〜からなる, 〜としては, 〜上, 〜により, 〜ことから, 〜ざるを得ない                                                                           |
| 18   | …に違いない, 〜に比べて, …ものだ・ものではない                                                                                               |
| 19   | 〜を対象に, 〜ばかりでなく, 〜にほかならない, 〜を通して, 〜から〜にかけて, 〜はともかく, 〜ためには                                         |
| 20   | 〜のもとで, …ぞ, …と同時に, 〜しかない, 〜の末, 〜て以来, 〜くらい                                                                           |
| 21   | 〜もせずに, 〜といえども, よほど〜でも, いかに〜か, …とか, 〜に言わせれば                                                                    |
| 22   | 〜次第だ, 〜をもって…とする, 〜においては, 〜うる, …のであろう, 〜と思われる                                                                 |
| 23   | 〜に及ぶ, …可能性がある, この〜, 〜上で, 〜につれて                                                                                          |
| 24   | 〜ざる〜, 〜から〜に至るまで, 〜きる, 〜ならぬ〜, 〜さえ〜ば, 〜として〜ない, 〜以上（は）, 〜ないかぎり, 〜わけにはいかない, 〜あまり（に） |

---

### Requirement: Функции трансформации глаголов

#### Уже реализовано

- `to_te_form` - て-форма
- `to_main_view` - основа глагола (連用形)

#### Требуется реализовать

- `to_masu_form` - ます-форма (настоящее время)
- `to_masen_form` - ません-форма (отрицание)
- `to_mashita_form` - ました-форма (прошедшее)
- `to_masen_deshita_form` - ませんでした-форма (отрицание прошедшего)
- `to_nai_form` - ない-форма (отрицание)
- `to_ta_form` - た-форма (прошедшее)
- `to_dictionary_form` - словарная форма
- `to_mashou_form` - ましょう-форма (волюнтив)
- `to_tai_form` - たい-форма (желание)
- `to_ba_form` - ば-форма (условная)
- `to_tara_form` - たら-форма (условная)
- `to_potential_form` - 可能形
- `to_passive_form` - 受身
- `to_causative_form` - 使役
- `to_causative_passive_form` - 使役受身
- `to_imperative_form` - 命令形
- `to_volitional_form` - 意向形
- `to_stem_form` - основа (для компаундов)
- `to_sou_form` - そう-форма (вид)
- `to_zu_form` - ず-форма
- `to_garu_form` - がる-форма

### Requirement: Функции трансформации i-прилагательных

#### Требуется реализовать

- `to_kunai_form` - くない (отрицание)
- `to_katta_form` - かった (прошедшее)
- `to_kunakatta_form` - くなかった (отрицание прошедшего)
- `to_kute_form` - くて (соединительная)
- `to_ku_form` - く (наречие)
- `to_kereba_form` - ければ (условная)
- `to_sou_form` - そう (вид)
- `to_sugiru_form` - すぎる (слишком)

### Requirement: Функции трансформации na-прилагательных

#### Требуется реализовать

- `to_na_form` - な (определительная)
- `to_nara_form` - なら (условная)
- `to_de_form` - で (соединительная)
- `to_sou_form` - そう (вид)

---

## Implementation Phases

### Phase 1: Базовые формы глаголов (N5)

1. ます/ません/ました/ませんでした
2. ましょう/ましょうか
3. ない-форма и её производные
4. た-форма и её производные

### Phase 2: Базовые формы прилагательных (N5)

1. i-adj: くない/かった/くなかった/くて/く
2. na-adj: じゃありません/でした/で/な/なら

### Phase 3: Продвинутые формы глаголов (N4)

1. ば/たら условные формы
2. 可能形/受身/使役
3. すぎる/やすい/にくい
4. Вежливые формы

### Phase 4: N3 формы

1. Компаунды (〜だす, 〜はじめる, etc.)
2. Сокращения (〜ちゃう, 〜とく, 〜てる)
3. 〜ず, 〜がる, 〜らしい

### Phase 5: Правила без format_map

1. Добавить все правила с format_map: null в grammar.json

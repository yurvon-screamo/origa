name: Release (latest) origa

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-latest-origa-ui
  cancel-in-progress: true

jobs:
  build_windows:
    name: Build Windows (desktop)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Dioxus CLI (dx)
        run: cargo install dioxus-cli --locked

      - name: Bundle (Windows .exe)
        working-directory: origa
        run: |
          dx bundle --desktop --release

      - name: Collect bundles
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/windows | Out-Null

          $searchRoots = @(
            "dist",
            "target/dx",
            "target"
          )

          $files = @()
          foreach ($root in $searchRoots) {
            if (Test-Path $root) {
              $files += Get-ChildItem -Path $root -Recurse -File -Include *.exe,*.msi -ErrorAction SilentlyContinue
            }
          }

          # Prefer dx bundle outputs if present
          $dxFiles = $files | Where-Object { $_.FullName -match "[\\/]target[\\/]dx[\\/]" }
          if ($dxFiles.Count -gt 0) { $files = $dxFiles }

          # Filter out obvious non-bundle binaries (debug artifacts)
          $files = $files | Where-Object { $_.FullName -notmatch "[\\/]target[\\/]debug[\\/]" }

          $files | ForEach-Object {
            Copy-Item $_.FullName -Destination (Join-Path "artifacts/windows" $_.Name) -Force
          }

          if (-not (Get-ChildItem -Path artifacts/windows -File -ErrorAction SilentlyContinue)) {
            Write-Host "Found files:"
            $files | Select-Object FullName | Format-Table -AutoSize | Out-String | Write-Host
            throw "No Windows bundle files were collected (expected .exe and/or .msi)."
          }

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: origa-windows
          path: artifacts/windows/*
          if-no-files-found: error

  build_android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            abi: arm64-v8a
            bt_abi: arm64_v8a
          - target: armv7-linux-androideabi
            abi: armeabi-v7a
            bt_abi: armeabi_v7a

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;26.1.10909125"

      - name: Export ANDROID_NDK_HOME
        run: |
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/26.1.10909125" >> "$GITHUB_ENV"
          echo "NDK_HOME=${ANDROID_SDK_ROOT}/ndk/26.1.10909125" >> "$GITHUB_ENV"

      - name: Install tooling (dx, cargo-ndk)
        run: |
          cargo install dioxus-cli --locked
          cargo install cargo-ndk --locked

      - name: Build AAB (${{ matrix.abi }})
        working-directory: origa
        run: |
          dx bundle \
            --android \
            --release \
            --target ${{ matrix.target }}

      - name: Download bundletool
        run: |
          curl -L -o bundletool.jar \
            https://github.com/google/bundletool/releases/download/1.16.0/bundletool-all-1.16.0.jar

      - name: Collect AAB
        run: |
          mkdir -p artifacts/android/${{ matrix.abi }}/aab

          AAB=$(find target/dx -type f -name "*.aab" | head -n 1)
          if [ -z "$AAB" ]; then
            echo "❌ AAB not found"
            exit 1
          fi

          cp "$AAB" artifacts/android/${{ matrix.abi }}/aab/

      - name: Convert AAB → APK (${{ matrix.abi }})
        run: |
          mkdir -p artifacts/android/${{ matrix.abi }}/apk

          AAB=$(find artifacts/android/${{ matrix.abi }}/aab -name "*.aab" | head -n 1)

          java -jar bundletool.jar build-apks \
            --bundle="$AAB" \
            --output=app.apks \
            --mode=default \
            --overwrite \
            --local-testing

          unzip -o app.apks -d apks

          find apks -name "*${{ matrix.bt_abi }}*.apk" \
            -exec cp {} artifacts/android/${{ matrix.abi }}/apk/ \;

          if ! ls artifacts/android/${{ matrix.abi }}/apk/*.apk >/dev/null 2>&1; then
            echo "❌ APK for ABI ${{ matrix.abi }} not found"
            exit 1
          fi

      - name: Upload artifact (Android ${{ matrix.abi }})
        uses: actions/upload-artifact@v4
        with:
          name: origa-android-${{ matrix.abi }}
          path: artifacts/android/${{ matrix.abi }}/
          if-no-files-found: error

  publish_latest:
    name: Publish GitHub Release (latest)
    runs-on: ubuntu-latest
    needs:
      - build_windows
      - build_android
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Force-update tag "latest"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest "${GITHUB_SHA}"
          git push -f origin latest

      - name: Create/Update Release "latest"
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: latest
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "artifacts/**/*"
          body: |
            Automated rolling release from `master`.

            Commit: `${{ github.sha }}`
